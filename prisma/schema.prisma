generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model GlobalSettings {
  id                       Int      @id @default(autoincrement())
  businessName             String   @default("Shield Hood Services")
  primaryPhone             String
  primaryEmail             String?
  baseDomain               String
  defaultStreetAddress     String?
  defaultCity              String?
  defaultState             String?
  defaultZip               String?
  defaultCountry           String?
  globalServiceDescription String?
  globalFAQ                String?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
}

model Location {
  id                      Int      @id @default(autoincrement())
  city                    String
  regionOrCounty          String
  state                   String
  country                 String   @default("USA")
  slug                    String   @unique
  pageTitleOverride       String?
  metaDescriptionOverride String?
  h1Override              String?
  streetAddress           String?
  zip                     String?
  phoneOverride           String?
  shortIntro              String
  longIntro               String
  mainBody                String
  whatTypicallyHappensNext String?
  servicesIntro           String?
  neighborhoodsOrAreas    String?
  localLandmarks          String?
  localStatsOrRegulationNotes String?
  localTestimonials       String?
  locationFAQ             String?
  googleMapsEmbedUrl      String
  published               Boolean  @default(false)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  services LocationService[]
  leads     Lead[]
  aiContent AIContentLog[]
}

model Service {
  id               Int      @id @default(autoincrement())
  name             String
  slug             String   @unique
  shortDescription String?
  longDescription  String?
  isPrimary        Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  locations LocationService[]
}

model LocationService {
  id         Int      @id @default(autoincrement())
  locationId Int
  serviceId  Int
  localNotes String?

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  service  Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([locationId, serviceId])
}

model Lead {
  id             Int       @id @default(autoincrement())
  name           String
  email          String?
  phone          String?
  restaurantName String?
  message        String?
  city           String?
  locationId     Int?
  pageUrl        String?
  createdAt      DateTime  @default(now())

  location Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)
}

model AIContentLog {
  id         Int      @id @default(autoincrement())
  locationId Int?
  scope      String
  createdAt  DateTime @default(now())

  location Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)
}

// Local SEO Pages System
model LocalPage {
  id                String    @id @default(uuid())
  primaryKeyword    String    // e.g., "hood-cleaning"
  primaryKeywordSlug String   // e.g., "hood-cleaning"
  city              String
  county            String?
  state             String    @default("CA")
  zip               String?   // For ZIP-based pages
  slug              String    @unique
  title             String
  metaDescription   String
  h1                String
  contentJson       Json      // Full content structure
  renderedHtml      String    @db.Text
  faqJson           Json?     // Array of {question, answer}
  schemaJsonld      Json?     // JSON-LD structured data
  internalLinksJson Json?     // Array of internal links
  uniquenessScore   Decimal?  @db.Decimal(5, 4) // 0.0000 to 1.0000
  safetyFlags       String[]  // Array of flag strings
  status            String    @default("draft") // "draft" | "published"
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  generationLogs    LocalPageGenerationLog[]

  @@index([slug])
  @@index([status])
  @@index([primaryKeywordSlug, status])
  @@index([city, state])
}

model LocalPageGenerationLog {
  id                String    @id @default(uuid())
  localPageId       String
  slug              String
  promptVersion     String
  status            String    // "success" | "failed" | "flagged"
  similarityScore  Decimal?  @db.Decimal(5, 4)
  safetyFlags       String[]
  notes             String?   @db.Text
  createdAt         DateTime  @default(now())

  localPage         LocalPage @relation(fields: [localPageId], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([localPageId])
}

model LocalCityContext {
  id              String    @id @default(uuid())
  city            String
  state           String    @default("CA")
  zip             String?   @unique
  localNotes      String?   @db.Text // Each line becomes a paragraph
  localResources  Json?     // Array of resource objects

  @@unique([city, state])
  @@index([zip])
}
